<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mama's Tindahan Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] } } } }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .animate-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden text-gray-900">

    <aside class="w-16 md:w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-40 pt-safe flex-shrink-0 transition-all">
        <div class="h-16 flex items-center justify-center md:justify-start px-0 md:px-6 border-b border-slate-700">
            <i class="fa-solid fa-store text-yellow-400 text-xl"></i> 
            <span class="hidden md:inline ml-3 font-bold text-lg">Mama's</span>
        </div>
        
        <nav class="flex-1 p-2 space-y-2 mt-2 overflow-y-auto scrollbar-hide">
            <button onclick="nav('pos')" id="btn-pos" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-cash-register text-xl w-6"></i><span class="hidden md:inline ml-3 font-medium">POS</span>
            </button>
            <button onclick="nav('inventory')" id="btn-inventory" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-boxes-stacked text-xl w-6"></i><span class="hidden md:inline ml-3 font-medium">Stocks</span>
            </button>
            <button onclick="nav('history')" id="btn-history" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-clock-rotate-left text-xl w-6"></i><span class="hidden md:inline ml-3 font-medium">History</span>
            </button>
            <button onclick="nav('analytics')" id="btn-analytics" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-chart-pie text-xl w-6"></i><span class="hidden md:inline ml-3 font-medium">Stats</span>
            </button>
            <button onclick="nav('ai')" id="btn-ai" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800 mt-4">
                <i class="fa-solid fa-robot text-xl w-6"></i><span class="hidden md:inline ml-3 font-medium">Advisor</span>
            </button>
        </nav>
        
        <div class="p-2 border-t border-slate-800 mb-safe pb-safe text-center">
            <button onclick="openSettings()" class="text-gray-500 hover:text-white p-3 w-full"><i class="fa-solid fa-gear"></i></button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden pt-safe w-full">
        
        <div id="syncStatus" class="bg-blue-600 text-white text-xs text-center py-1 hidden">
            <i class="fa-solid fa-cloud-arrow-down animate-bounce mr-2"></i> Syncing with Google Sheets...
        </div>

        <section id="pos" class="page-section h-full flex relative">
            <div class="flex-1 p-4 overflow-y-auto scrollbar-hide bg-gray-50 pb-32 md:pb-6">
                <div class="flex gap-2 mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <input type="text" id="search" onkeyup="renderPOS()" placeholder="Search..." class="flex-1 p-3 rounded-xl border shadow-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <select id="catFilter" onchange="renderPOS()" class="p-3 rounded-xl border shadow-sm bg-white font-medium max-w-[100px]"><option value="All">All</option></select>
                </div>
                <div id="posGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            </div>

            <div class="md:hidden fixed bottom-0 left-16 right-0 bg-white border-t p-4 shadow-2xl z-30 flex items-center justify-between pb-safe">
                <div>
                    <div class="text-[10px] text-gray-500 font-bold uppercase">Total</div>
                    <div class="text-xl font-bold text-gray-800" id="mobileTotal">₱0.00</div>
                </div>
                <button onclick="toggleCart()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex gap-2 items-center active:scale-95 transition">
                    Order <span id="mobileCount" class="bg-white text-green-600 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>

            <div id="cartContainer" class="hidden md:flex flex-col md:w-96 bg-white md:shadow-xl md:border-l z-40 fixed md:relative inset-0 md:inset-auto">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center pt-safe md:pt-4">
                    <button onclick="toggleCart()" class="md:hidden text-gray-500 p-2"><i class="fa-solid fa-chevron-down text-xl"></i></button>
                    <h3 class="font-bold text-gray-800">Current Order</h3>
                    <button onclick="clearCart()" class="text-red-500 text-xs font-bold p-2">CLEAR</button>
                </div>
                <div id="cartList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
                <div class="p-4 bg-gray-50 border-t space-y-3 pb-safe md:pb-4">
                    <div class="flex justify-between text-xl font-bold text-gray-800"><span>Total</span><span id="totalDisplay">₱0.00</span></div>
                    <div class="flex items-center gap-2 bg-white p-2 rounded border"><span class="text-gray-500 text-xs font-bold">CASH</span><input type="number" id="cashInput" oninput="calcChange()" class="flex-1 text-right font-bold outline-none" placeholder="0"></div>
                    <div class="flex justify-between font-bold text-blue-600"><span>Change</span><span id="changeDisplay">₱0.00</span></div>
                    <button onclick="checkout()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">PAY NOW</button>
                </div>
            </div>
        </section>

        <section id="inventory" class="page-section hidden h-full p-4 overflow-y-auto pb-safe">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Inventory</h2>
                <button onclick="openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded shadow text-sm font-bold"><i class="fa-solid fa-plus"></i> Add</button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 border-b"><tr><th class="p-3">Item</th><th class="p-3">Price</th><th class="p-3 text-center">Act</th></tr></thead>
                    <tbody id="inventoryTable"></tbody>
                </table>
            </div>
        </section>

        <section id="history" class="page-section hidden h-full p-4 overflow-y-auto pb-safe">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Sales History</h2>
                <button onclick="syncData()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm"><i class="fa-solid fa-rotate"></i> Refresh</button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 border-b">
                        <tr><th class="p-3">Date</th><th class="p-3">Items</th><th class="p-3 text-right">Total</th></tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </section>

        <section id="analytics" class="page-section hidden h-full p-4 overflow-y-auto pb-safe">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Sales Dashboard</h2>
            
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">Today's Sales</p>
                    <p id="statDaily" class="text-xl font-bold text-gray-800 mt-1">₱0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">Transactions</p>
                    <p id="statCount" class="text-xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">Top Seller</p>
                    <p id="statTop" class="text-sm font-bold text-gray-800 mt-2 truncate">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400">
                    <p class="text-xs text-gray-500 font-bold uppercase">Least Selling</p>
                    <p id="statLow" class="text-sm font-bold text-gray-800 mt-2 truncate">--</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-4 rounded-xl shadow h-80 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">Best Product Combinations</h3>
                    <div class="flex-1 relative w-full h-full flex items-center justify-center">
                        <canvas id="comboChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow h-80 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">Peak Hours (Store Activity)</h3>
                    <div class="flex-1 relative w-full h-full">
                        <canvas id="peakChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow h-72 w-full mb-10">
                <h3 class="font-bold text-gray-700 mb-2 text-sm">Daily Sales Trend</h3>
                <div class="relative w-full h-56">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </section>

        <section id="ai" class="page-section hidden h-full flex flex-col bg-gray-50">
            <div class="p-4 bg-white shadow z-10 pt-safe flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                <h2 class="font-bold">AI Advisor</h2>
            </div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow text-sm max-w-[85%]">Hello! I can read your Google Sheet data. Ask away!</div>
            </div>
            <div class="p-3 bg-white border-t flex gap-2 pb-safe">
                <input type="text" id="aiInput" class="flex-1 p-3 rounded-full border bg-gray-100 outline-none" placeholder="Ask...">
                <button onclick="sendToAI()" class="bg-purple-600 text-white w-10 h-10 rounded-full shadow"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </section>
    </main>

    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-pop">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 block mb-1">Google App Script URL (Linked)</label>
                <input id="dbUrl" class="w-full p-3 border rounded bg-gray-100 text-sm text-gray-500 cursor-not-allowed" disabled>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 block mb-1">Groq API Key</label>
                <input id="aiKey" type="password" class="w-full p-3 border rounded bg-gray-50 text-sm">
            </div>
            <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Save Settings</button>
            <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="w-full text-gray-500 py-2 mt-2">Close</button>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-pop">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Edit</h3>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editId">
                <input id="editName" class="w-full p-3 border rounded mb-3" placeholder="Name" required>
                <select id="editCat" class="w-full p-3 border rounded mb-3 bg-white"></select>
                <input type="number" id="editPrice" step="0.25" class="w-full p-3 border rounded mb-4" placeholder="Price" required>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-500">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="receiptModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden animate-pop">
            <div class="bg-green-600 p-6 text-center text-white">
                <i class="fa-solid fa-check-circle text-4xl mb-2"></i>
                <h3 class="text-xl font-bold">Success!</h3>
            </div>
            <div class="p-6">
                <div class="flex justify-between mb-2"><span>Total</span><span id="rTotal" class="font-bold">₱0.00</span></div>
                <div class="flex justify-between mb-2"><span>Cash</span><span id="rCash">₱0.00</span></div>
                <div class="flex justify-between mb-4 text-blue-600 font-bold text-lg"><span>Change</span><span id="rChange">₱0.00</span></div>
                <button onclick="closeReceipt()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Next Order</button>
            </div>
        </div>
    </div>

    <script>
        // --- HARDCODED DATABASE CONNECTION ---
        const LINKED_DB_URL = "https://script.google.com/macros/s/AKfycbxu297K4HDNSI1vZNRUCTazAS1fad2EK7Rg6w_YiqRScQ-9F-v_mYHziGMa9qsJU18rsA/exec";

        // DATA
        let products = [];
        let sales = [];
        let cart = [];
        let dbUrl = LINKED_DB_URL; // Force use this URL
        let apiKey = localStorage.getItem('groq_key');

        // INIT
        window.onload = async () => { 
            await syncData(); // Auto sync on load
            nav('pos'); 
            updateStats(); 
        };

        // SYNC WITH GOOGLE SHEETS
        async function syncData() {
            document.getElementById('syncStatus').classList.remove('hidden');
            try {
                const res = await fetch(dbUrl);
                const data = await res.json();
                products = data.products;
                sales = data.sales;
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('sales', JSON.stringify(sales));
                renderPOS();
                renderInventory();
                renderHistory();
                updateStats();
            } catch(e) { 
                console.error("Sync Error:", e); 
                // Fallback to local if offline
                products = JSON.parse(localStorage.getItem('products')) || [];
                sales = JSON.parse(localStorage.getItem('sales')) || [];
            }
            document.getElementById('syncStatus').classList.add('hidden');
        }

        async function pushSale(sale) {
            fetch(dbUrl, { method: 'POST', body: JSON.stringify({ action: 'add_sale', ...sale }) });
        }

        async function pushInventory() {
            fetch(dbUrl, { method: 'POST', body: JSON.stringify({ action: 'update_inventory', products: products }) });
        }

        // NAV
        function nav(id) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.replace('text-white', 'text-slate-300');
                b.classList.remove('bg-blue-600', 'text-purple-400');
            });
            
            const btn = document.getElementById('btn-' + id);
            if(btn) {
                btn.classList.replace('text-slate-300', 'text-white');
                if(id === 'ai') btn.classList.add('text-purple-400'); 
                else btn.classList.add('bg-blue-600');
            }
            if(id === 'pos') renderPOS();
            if(id === 'inventory') renderInventory();
            if(id === 'history') renderHistory();
            if(id === 'analytics') updateStats();
        }

        // POS LOGIC
        function renderPOS() {
            const grid = document.getElementById('posGrid');
            const search = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const cats = ['All', ...new Set(products.map(p => p.cat))];
            const sel = document.getElementById('catFilter');
            if(sel.options.length === 1) cats.forEach(c => { if(c!=='All') sel.innerHTML += `<option value="${c}">${c}</option>` });

            grid.innerHTML = '';
            products.filter(p => (cat==='All' || p.cat===cat) && p.name.toLowerCase().includes(search)).forEach(p => {
                grid.innerHTML += `
                <div onclick="addToCart(${p.id})" class="bg-white p-3 rounded-xl shadow-sm border active:scale-95 transition flex flex-col justify-between h-24">
                    <div><span class="text-[10px] text-gray-400 font-bold uppercase">${p.cat}</span><h4 class="font-bold text-sm leading-tight line-clamp-2">${p.name}</h4></div>
                    <div class="text-right"><span class="bg-blue-50 text-blue-700 text-xs font-bold px-2 py-1 rounded">₱${p.price}</span></div>
                </div>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.qty++; else cart.push({...p, qty:1});
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            let total = 0, count = 0;
            cart.forEach((i, idx) => {
                total += i.price * i.qty; count += i.qty;
                list.innerHTML += `
                <div class="flex justify-between items-center bg-white p-2 border-b">
                    <div><div class="font-bold text-sm">${i.name}</div><div class="text-xs text-gray-500">₱${i.price} x ${i.qty}</div></div>
                    <div class="flex gap-2"><button onclick="mod(${idx},-1)" class="w-7 h-7 bg-gray-100 rounded-full font-bold text-red-500">-</button><span class="w-4 text-center text-sm font-bold">${i.qty}</span><button onclick="mod(${idx},1)" class="w-7 h-7 bg-gray-100 rounded-full font-bold text-green-600">+</button></div>
                </div>`;
            });
            document.getElementById('totalDisplay').innerText = `₱${total.toFixed(2)}`;
            document.getElementById('mobileTotal').innerText = `₱${total.toFixed(2)}`;
            document.getElementById('mobileCount').innerText = count;
            calcChange();
        }

        function mod(i, v) { cart[i].qty += v; if(cart[i].qty <= 0) cart.splice(i, 1); renderCart(); }
        function toggleCart() {
            const c = document.getElementById('cartContainer');
            c.classList.toggle('hidden'); c.classList.toggle('flex'); c.classList.add('animate-slide-up');
        }
        function clearCart() { cart=[]; document.getElementById('cashInput').value=''; renderCart(); if(window.innerWidth<768) toggleCart(); }
        
        function calcChange() {
            const t = parseFloat(document.getElementById('totalDisplay').innerText.replace('₱',''));
            const c = parseFloat(document.getElementById('cashInput').value) || 0;
            const ch = c - t;
            const el = document.getElementById('changeDisplay');
            el.innerText = ch >= 0 ? `₱${ch.toFixed(2)}` : 'Insufficient';
            el.className = ch >= 0 ? 'text-blue-600 font-bold' : 'text-red-500 font-bold';
        }

        function checkout() {
            if(!cart.length) return alert('Empty Cart');
            const t = parseFloat(document.getElementById('totalDisplay').innerText.replace('₱',''));
            const c = parseFloat(document.getElementById('cashInput').value) || 0;
            if(c < t) return alert('Insufficient Cash');
            
            const sale = {id:Date.now(), date:new Date().toISOString(), total:t, items:[...cart]};
            sales.unshift(sale); 
            pushSale(sale);
            
            document.getElementById('rTotal').innerText = `₱${t.toFixed(2)}`;
            document.getElementById('rCash').innerText = `₱${c.toFixed(2)}`;
            document.getElementById('rChange').innerText = `₱${(c-t).toFixed(2)}`;
            document.getElementById('receiptModal').classList.remove('hidden');
            
            cart=[]; document.getElementById('cashInput').value=''; renderCart(); updateStats();
            if(window.innerWidth<768) document.getElementById('cartContainer').classList.add('hidden');
        }
        
        function closeReceipt() { document.getElementById('receiptModal').classList.add('hidden'); }

        // INVENTORY
        function renderInventory() {
            const t = document.getElementById('inventoryTable'); t.innerHTML='';
            products.forEach(p => {
                t.innerHTML += `<tr class="border-b"><td class="p-3">${p.name}</td><td class="p-3">₱${p.price}</td><td class="p-3 text-center"><button onclick="edit(${p.id})" class="text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="del(${p.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        
        function openModal(mode, id) {
            document.getElementById('productModal').classList.remove('hidden');
            const sel = document.getElementById('editCat'); sel.innerHTML='';
            [...new Set(products.map(p=>p.cat)), '+ New'].forEach(c=>sel.innerHTML+=`<option value="${c}">${c}</option>`);
            
            if(mode==='edit') {
                const p = products.find(x=>x.id===id);
                document.getElementById('editId').value=p.id; document.getElementById('editName').value=p.name;
                document.getElementById('editPrice').value=p.price; sel.value=p.cat;
            } else {
                document.getElementById('editId').value=''; document.forms[0].reset();
            }
        }
        function closeModal() { document.getElementById('productModal').classList.add('hidden'); }
        function edit(id) { openModal('edit', id); }
        function del(id) { 
            if(confirm('Delete?')) { 
                products=products.filter(p=>p.id!==id); 
                pushInventory(); 
                renderInventory(); 
            } 
        }
        
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const price = parseFloat(document.getElementById('editPrice').value);
            let cat = document.getElementById('editCat').value;
            if(cat==='+ New') cat = prompt('Category:') || 'Misc';
            
            if(id) {
                const idx = products.findIndex(p=>p.id==id); products[idx]={id:parseInt(id),name,price,cat};
            } else {
                products.push({id:Date.now(), name, price, cat});
            }
            pushInventory(); 
            closeModal(); renderInventory();
        }

        // HISTORY
        function renderHistory() {
            const t = document.getElementById('historyTable'); t.innerHTML = '';
            sales.slice(0, 50).forEach(s => {
                const date = new Date(s.date).toLocaleDateString();
                const items = s.items.map(i => `${i.name} (x${i.qty})`).join(', ');
                t.innerHTML += `<tr class="border-b"><td class="p-3 text-gray-500">${date}</td><td class="p-3 truncate max-w-[150px]">${items}</td><td class="p-3 text-right font-bold">₱${s.total}</td></tr>`;
            });
        }

        // STATS (RESTORED JS)
        let salesChart, comboChart, peakChart;
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const daily = sales.filter(s => s.date.startsWith(today)).reduce((a,b) => a + b.total, 0);
            
            const itemCounts = {};
            sales.forEach(s => s.items.forEach(i => itemCounts[i.name] = (itemCounts[i.name] || 0) + i.qty));
            const sortedItems = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]);
            const top = sortedItems.length ? `${sortedItems[0][0]} (${sortedItems[0][1]})` : "--";
            
            const allNames = products.map(p => p.name);
            const soldNames = Object.keys(itemCounts);
            const unsold = allNames.filter(n => !soldNames.includes(n));
            let low = "--";
            if(unsold.length) low = unsold[0] + " (0)";
            else if(sortedItems.length) { const l = sortedItems[sortedItems.length-1]; low = `${l[0]} (${l[1]})`; }

            document.getElementById('statDaily').innerText = '₱' + daily.toFixed(2);
            document.getElementById('statCount').innerText = sales.length;
            document.getElementById('statTop').innerText = top;
            document.getElementById('statLow').innerText = low;

            // Sales Chart
            const ctxS = document.getElementById('salesChart').getContext('2d');
            if(salesChart) salesChart.destroy();
            const labels=[], data=[];
            for(let i=6; i>=0; i--) {
                const d=new Date(); d.setDate(d.getDate()-i); const ds=d.toISOString().split('T')[0];
                labels.push(ds.slice(5)); data.push(sales.filter(s=>s.date.startsWith(ds)).reduce((a,b)=>a+b.total,0));
            }
            salesChart=new Chart(ctxS,{type:'bar',data:{labels,datasets:[{label:'Sales',data,backgroundColor:'#3b82f6',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false}});

            // Combo Chart
            const pairs={};
            sales.forEach(s=>{ if(s.items.length>1){ const n=s.items.map(i=>i.name).sort(); for(let i=0;i<n.length;i++)for(let j=i+1;j<n.length;j++) pairs[n[i]+"+"+n[j]]=(pairs[n[i]+"+"+n[j]]||0)+1; }});
            const sPairs=Object.entries(pairs).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctxC = document.getElementById('comboChart').getContext('2d');
            if(comboChart) comboChart.destroy();
            comboChart=new Chart(ctxC,{type:'doughnut',data:{labels:sPairs.map(p=>p[0]),datasets:[{data:sPairs.map(p=>p[1]),backgroundColor:['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:10,font:{size:9}}}}}});

            // Peak Chart
            const hC=new Array(24).fill(0); sales.forEach(s=>hC[new Date(s.date).getHours()]++);
            const hL=hC.map((_,i)=>i%6===0?(i>12?i-12+'pm':i+'am'):'');
            const ctxP = document.getElementById('peakChart').getContext('2d');
            if(peakChart) peakChart.destroy();
            peakChart=new Chart(ctxP,{type:'line',data:{labels:hL,datasets:[{label:'Orders',data:hC,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}}}}});
        }

        // SETTINGS & AI
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('dbUrl').value = dbUrl; // Show the active URL
            document.getElementById('aiKey').value = apiKey || '';
        }

        async function saveSettings() {
            const key = document.getElementById('aiKey').value;
            localStorage.setItem('groq_key', key);
            apiKey = key;
            await syncData(); // Retry sync
            document.getElementById('settingsModal').classList.add('hidden');
            alert('Settings Saved!');
        }
        
        async function sendToAI() {
            if(!apiKey) return openSettings();
            const i = document.getElementById('aiInput'); const t = i.value; if(!t)return;
            const c = document.getElementById('chatContainer');
            c.innerHTML+=`<div class="flex justify-end"><div class="bg-blue-600 text-white p-3 rounded-l-xl rounded-br-xl shadow text-sm">${t}</div></div>`;
            i.value=''; c.scrollTop=c.scrollHeight;
            
            const salesTxt = `Today: ${document.getElementById('statDaily').innerText}. Top: ${document.getElementById('statTop').innerText}.`;
            try {
                const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method:"POST", headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
                    body:JSON.stringify({messages:[{role:"system",content:`Store advisor. Data: ${salesTxt}. Brief answer.`},{role:"user",content:t}],model:"llama3-8b-8192"})
                });
                const d = await r.json();
                c.innerHTML+=`<div class="flex gap-2"><div class="bg-purple-600 w-8 h-8 rounded-full flex items-center justify-center text-white shrink-0"><i class="fa-solid fa-robot text-xs"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow text-sm border">${d.choices[0].message.content}</div></div>`;
            } catch(e) { alert(e.message); }
            c.scrollTop=c.scrollHeight;
        }
    </script>
</body>
</html>
