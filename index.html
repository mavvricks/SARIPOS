<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mama's Tindahan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(100%); } 100% { transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <aside class="w-16 md:w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-40 transition-all duration-300 flex-shrink-0">
        <div class="p-4 h-16 flex items-center justify-center md:justify-start border-b border-slate-700 whitespace-nowrap overflow-hidden">
            <i class="fa-solid fa-store text-yellow-400 text-xl"></i> 
            <span class="hidden md:inline ml-3 font-bold text-lg">Mama's Tindahan</span>
        </div>
        
        <nav class="flex-1 p-2 space-y-2 mt-2 overflow-y-auto scrollbar-hide">
            <button id="btn-pos" onclick="nav('pos')" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-cash-register text-xl w-8 text-center"></i> 
                <span class="hidden md:inline ml-2 font-medium">POS</span>
            </button>
            <button id="btn-inventory" onclick="nav('inventory')" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-boxes-stacked text-xl w-8 text-center"></i> 
                <span class="hidden md:inline ml-2 font-medium">Inventory</span>
            </button>
            <button id="btn-analytics" onclick="nav('analytics')" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800">
                <i class="fa-solid fa-chart-pie text-xl w-8 text-center"></i> 
                <span class="hidden md:inline ml-2 font-medium">Analytics</span>
            </button>
            <button id="btn-ai" onclick="nav('ai')" class="nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800 mt-4">
                <i class="fa-solid fa-robot text-xl w-8 text-center"></i> 
                <span class="hidden md:inline ml-2 font-medium">Advisor</span>
            </button>
        </nav>
        
        <div class="p-2 border-t border-slate-800 mb-safe">
            <button onclick="enterApiKey()" class="text-xs text-gray-500 hover:text-white w-full text-center py-2">
                <i class="fa-solid fa-key"></i>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden w-full">
        
        <section id="pos" class="page-section h-full flex relative">
            
            <div class="flex-1 p-4 md:p-6 overflow-y-auto scrollbar-hide bg-gray-50 pb-24 md:pb-6">
                <div class="flex gap-2 mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <input type="text" id="search" onkeyup="renderPOS()" placeholder="Search..." class="flex-1 p-3 rounded-xl border shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="catFilter" onchange="renderPOS()" class="p-3 rounded-xl border shadow-sm bg-white max-w-[100px] md:max-w-xs">
                        <option value="All">All</option>
                    </select>
                </div>
                <div id="posGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4"></div>
            </div>

            <div class="md:hidden fixed bottom-0 left-16 right-0 bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 flex items-center justify-between">
                <div>
                    <div class="text-xs text-gray-500 font-bold uppercase">Total Due</div>
                    <div class="text-xl font-bold text-gray-800" id="mobileTotalDisplay">₱0.00</div>
                </div>
                <button onclick="toggleCartMobile()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 active:scale-95 transition">
                    <span>View Order</span>
                    <div id="mobileCartCount" class="bg-white text-green-600 text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">0</div>
                </button>
            </div>

            <div id="cartContainer" class="hidden md:flex flex-col md:w-96 bg-white md:shadow-xl md:border-l z-40 fixed md:relative inset-0 md:inset-auto">
                
                <div class="md:hidden p-4 bg-gray-50 border-b flex justify-between items-center">
                    <button onclick="toggleCartMobile()" class="text-gray-500 hover:text-gray-800">
                        <i class="fa-solid fa-chevron-down text-xl"></i>
                    </button>
                    <h3 class="font-bold text-gray-800">Current Order</h3>
                    <button onclick="clearCart()" class="text-red-500 font-bold text-sm">Clear</button>
                </div>

                <div class="hidden md:flex p-4 border-b bg-gray-50 justify-between items-center">
                    <h3 class="font-bold text-gray-700">Current Order</h3>
                    <button onclick="clearCart()" class="text-xs text-red-500 font-bold hover:underline">CLEAR</button>
                </div>
                
                <div id="cartList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
                
                <div class="p-4 bg-gray-50 border-t space-y-3 pb-safe">
                    <div class="flex justify-between text-xl font-bold text-gray-800">
                        <span>Total Due</span>
                        <span id="totalDisplay">₱0.00</span>
                    </div>
                    
                    <div class="flex items-center gap-2 bg-white p-2 rounded-lg border">
                        <span class="text-gray-500 text-sm font-bold w-12">Cash</span>
                        <input type="number" id="cashInput" oninput="calculateChange()" class="flex-1 text-right font-bold text-gray-800 text-lg outline-none" placeholder="0.00">
                    </div>

                    <div class="flex justify-between text-lg font-bold text-gray-600 border-b pb-2">
                        <span>Change</span>
                        <span id="changeDisplay" class="text-blue-600">₱0.00</span>
                    </div>

                    <button onclick="checkout()" class="w-full bg-green-600 active:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition transform active:scale-95">
                        PAY NOW
                    </button>
                </div>
            </div>
        </section>

        <section id="inventory" class="page-section hidden h-full p-4 md:p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">Inventory</h2>
                <button onclick="openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 text-sm font-bold">
                    <i class="fa-solid fa-plus mr-1"></i> Add Item
                </button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-x-auto">
                <table class="w-full text-left min-w-[600px] md:min-w-0">
                    <thead class="bg-gray-100 border-b text-gray-600 font-bold text-sm">
                        <tr>
                            <th class="p-4">Name</th>
                            <th class="p-4">Category</th>
                            <th class="p-4">Price</th>
                            <th class="p-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable" class="text-sm"></tbody>
                </table>
            </div>
        </section>

        <section id="analytics" class="page-section hidden h-full p-4 md:p-6 overflow-y-auto">
            <h2 class="text-xl md:text-2xl font-bold mb-6 text-gray-800">Dashboard</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Today's Sales</p>
                    <p id="statDaily" class="text-2xl font-bold text-gray-800 mt-1">₱0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Transactions</p>
                    <p id="statCount" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Top Seller</p>
                    <p id="statTop" class="text-md font-bold text-gray-800 mt-2 truncate">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400">
                    <p class="text-gray-500 text-xs font-bold uppercase">Least Selling</p>
                    <p id="statLow" class="text-md font-bold text-gray-800 mt-2 truncate">--</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="bg-white p-4 rounded-xl shadow h-80 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">Combos</h3>
                    <div class="flex-1 relative w-full h-full flex items-center justify-center">
                        <canvas id="comboChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow h-80 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">Peak Hours</h3>
                    <div class="flex-1 relative w-full h-full">
                        <canvas id="peakChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow h-72 w-full mb-10">
                <h3 class="font-bold text-gray-700 mb-2 text-sm">Sales Trend</h3>
                <div class="relative w-full h-56">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </section>

        <section id="ai" class="page-section hidden h-full flex flex-col bg-gray-50">
            <div class="p-4 bg-white shadow-sm z-10 border-b flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Store Advisor</h2>
                    <p class="text-xs text-gray-500">Powered by Groq</p>
                </div>
            </div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white shrink-0 text-xs"><i class="fa-solid fa-robot"></i></div>
                    <div class="bg-white p-3 rounded-r-2xl rounded-bl-2xl shadow-sm border text-gray-700 max-w-[85%] text-sm">
                        Hello! Ask me about your sales or strategy.
                    </div>
                </div>
            </div>
            <div class="p-3 bg-white border-t flex gap-2 pb-safe">
                <input type="text" id="aiInput" placeholder="Ask your advisor..." class="flex-1 p-3 rounded-full border bg-gray-100 focus:bg-white focus:ring-2 focus:ring-purple-500 outline-none transition text-sm">
                <button onclick="sendToAI()" class="bg-purple-600 text-white w-10 h-10 rounded-full hover:bg-purple-700 transition flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </section>
    </main>

    <div id="productModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="p-6">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">Edit Product</h3>
                <form id="productForm" onsubmit="saveProduct(event)">
                    <input type="hidden" id="editId">
                    <div class="mb-4">
                        <label class="block text-gray-600 text-xs font-bold mb-1">Name</label>
                        <input type="text" id="editName" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 text-xs font-bold mb-1">Category</label>
                        <select id="editCat" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white outline-none"></select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-600 text-xs font-bold mb-1">Price (₱)</label>
                        <input type="number" id="editPrice" step="0.25" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold text-sm">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold shadow text-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="receiptModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden animate-pop">
            <div class="bg-green-600 p-6 text-center">
                <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-md shadow-inner">
                    <i class="fa-solid fa-check text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Success!</h3>
            </div>
            <div class="p-6">
                <div class="space-y-2 mb-6 text-sm">
                    <div class="flex justify-between text-gray-600"><span>Total</span><span id="receiptTotal" class="font-bold text-gray-800">₱0.00</span></div>
                    <div class="flex justify-between text-gray-600"><span>Cash</span><span id="receiptCash">₱0.00</span></div>
                    <div class="border-t border-dashed my-2"></div>
                    <div class="flex justify-between text-blue-600 font-bold text-lg"><span>Change</span><span id="receiptChange">₱0.00</span></div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 mb-6 max-h-32 overflow-y-auto text-xs border" id="receiptItems"></div>
                <button onclick="closeReceipt()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg text-sm">New Order</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let products = JSON.parse(localStorage.getItem('products')) || [
            { id: 1, name: 'Sardines (Mega)', cat: 'Canned', price: 24.00 },
            { id: 2, name: 'Pancit Canton', cat: 'Noodles', price: 18.00 },
            { id: 3, name: 'Marlboro Red', cat: 'Cigarettes', price: 12.00 },
            { id: 4, name: 'Kopiko Blanca', cat: 'Coffee', price: 15.00 },
            { id: 5, name: 'Skyflakes', cat: 'Biscuits', price: 8.00 },
            { id: 6, name: 'Coke Mismo', cat: 'Drinks', price: 20.00 }
        ];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let cart = [];
        let apiKey = localStorage.getItem('groq_key') || '';

        // --- INIT ---
        window.onload = () => { nav('pos'); updateStats(); };

        // --- NAVIGATION ---
        function nav(section) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(section).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-slate-300 hover:bg-slate-800";
            });
            const activeBtn = document.getElementById('btn-' + section);
            if(activeBtn) {
                if(section === 'ai') activeBtn.className = "nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-white shadow-lg bg-gradient-to-br from-purple-600 to-indigo-700";
                else activeBtn.className = "nav-btn w-full p-3 rounded-xl transition flex items-center justify-center md:justify-start text-white shadow-lg bg-blue-600";
            }
            if(section === 'pos') renderPOS();
            if(section === 'inventory') renderInventory();
            if(section === 'analytics') updateStats();
        }

        // --- MOBILE CART TOGGLE ---
        function toggleCartMobile() {
            const cart = document.getElementById('cartContainer');
            if (cart.classList.contains('hidden')) {
                cart.classList.remove('hidden');
                cart.classList.add('flex', 'animate-slide-up');
            } else {
                cart.classList.add('hidden');
                cart.classList.remove('flex', 'animate-slide-up');
            }
        }

        // --- POS ENGINE ---
        function renderPOS() {
            const grid = document.getElementById('posGrid');
            const search = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const categories = ['All', ...new Set(products.map(p => p.cat))];
            const catSelect = document.getElementById('catFilter');
            if(catSelect.options.length === 1) { categories.forEach(c => { if(c !== 'All') catSelect.innerHTML += `<option value="${c}">${c}</option>`; }); }
            
            grid.innerHTML = '';
            products.filter(p => (cat === 'All' || p.cat === cat) && p.name.toLowerCase().includes(search)).forEach(p => {
                grid.innerHTML += `
                    <div onclick="addToCart(${p.id})" class="bg-white p-3 md:p-4 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition cursor-pointer flex flex-col justify-between h-28 md:h-32">
                        <div>
                            <span class="text-[10px] font-bold uppercase text-gray-400 block mb-1">${p.cat}</span>
                            <h4 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2">${p.name}</h4>
                        </div>
                        <div class="text-right">
                            <span class="bg-blue-50 text-blue-700 font-bold px-2 py-1 rounded text-xs">₱${parseFloat(p.price).toFixed(2)}</span>
                        </div>
                    </div>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.qty++; else cart.push({...p, qty: 1});
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            let total = 0;
            let count = 0;
            cart.forEach((item, idx) => {
                total += item.price * item.qty;
                count += item.qty;
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-2 border-b last:border-0">
                        <div class="flex-1">
                            <div class="font-bold text-sm text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500">₱${parseFloat(item.price).toFixed(2)} x ${item.qty}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="modQty(${idx}, -1)" class="w-7 h-7 rounded-full bg-gray-100 text-red-500 font-bold">-</button>
                            <span class="font-bold w-4 text-center text-sm">${item.qty}</span>
                            <button onclick="modQty(${idx}, 1)" class="w-7 h-7 rounded-full bg-gray-100 text-green-600 font-bold">+</button>
                        </div>
                    </div>`;
            });
            
            // Update Totals
            const totalStr = '₱' + total.toFixed(2);
            document.getElementById('totalDisplay').innerText = totalStr;
            document.getElementById('mobileTotalDisplay').innerText = totalStr;
            document.getElementById('mobileCartCount').innerText = count;
            calculateChange();
        }

        function modQty(idx, val) {
            cart[idx].qty += val;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        function clearCart() { 
            cart = []; 
            document.getElementById('cashInput').value = '';
            document.getElementById('changeDisplay').innerText = '₱0.00';
            renderCart(); 
            // If on mobile, close cart
            if(window.innerWidth < 768) document.getElementById('cartContainer').classList.add('hidden');
        }

        function calculateChange() {
            const total = parseFloat(document.getElementById('totalDisplay').innerText.replace('₱', ''));
            const cash = parseFloat(document.getElementById('cashInput').value) || 0;
            const change = cash - total;
            const el = document.getElementById('changeDisplay');
            if(change >= 0) {
                el.innerText = '₱' + change.toFixed(2);
                el.className = "text-blue-600";
            } else {
                el.innerText = 'Insufficient';
                el.className = "text-red-500";
            }
        }

        function checkout() {
            if(!cart.length) return alert("Cart empty");
            const total = parseFloat(document.getElementById('totalDisplay').innerText.replace('₱', ''));
            const cash = parseFloat(document.getElementById('cashInput').value) || 0;
            if (cash < total) return alert("Insufficient Cash!");
            
            const change = cash - total;
            sales.push({ id: Date.now(), date: new Date().toISOString(), total: total, items: [...cart] });
            localStorage.setItem('sales', JSON.stringify(sales));
            
            // Show Receipt
            document.getElementById('receiptTotal').innerText = '₱' + total.toFixed(2);
            document.getElementById('receiptCash').innerText = '₱' + cash.toFixed(2);
            document.getElementById('receiptChange').innerText = '₱' + change.toFixed(2);
            const rList = document.getElementById('receiptItems');
            rList.innerHTML = '';
            cart.forEach(i => rList.innerHTML += `<div class="flex justify-between mb-1"><span>${i.name} x${i.qty}</span><span>₱${(i.price*i.qty).toFixed(2)}</span></div>`);
            
            document.getElementById('receiptModal').classList.remove('hidden');
            cart = [];
            document.getElementById('cashInput').value = '';
            renderCart();
            updateStats();
            // Close mobile cart if open
            document.getElementById('cartContainer').classList.add('hidden');
            document.getElementById('cartContainer').classList.remove('flex');
        }

        function closeReceipt() { document.getElementById('receiptModal').classList.add('hidden'); }

        // --- INVENTORY ---
        function renderInventory() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';
            products.forEach(p => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                        <td class="p-4 hidden md:table-cell"><span class="px-2 py-1 bg-gray-200 text-xs rounded-full">${p.cat}</span></td>
                        <td class="p-4">₱${parseFloat(p.price).toFixed(2)}</td>
                        <td class="p-4 text-center space-x-2">
                            <button onclick="openModal('edit', ${p.id})" class="text-blue-500 p-2"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteProd(${p.id})" class="text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- MODAL (PRODUCT) ---
        function openModal(mode, id = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('productForm');
            const catSelect = document.getElementById('editCat');
            catSelect.innerHTML = '';
            const cats = [...new Set(products.map(p => p.cat))];
            cats.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            catSelect.innerHTML += `<option value="__new__">+ New...</option>`;

            if(mode === 'edit' && id) {
                title.innerText = 'Edit Product';
                const p = products.find(x => x.id === id);
                document.getElementById('editId').value = p.id;
                document.getElementById('editName').value = p.name;
                document.getElementById('editPrice').value = p.price;
                catSelect.value = p.cat;
            } else {
                title.innerText = 'Add Product';
                form.reset();
                document.getElementById('editId').value = '';
            }
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('productModal').classList.add('hidden'); }
        
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const price = parseFloat(document.getElementById('editPrice').value);
            let cat = document.getElementById('editCat').value;
            if(cat === '__new__') cat = prompt("Category Name:") || 'Misc';
            
            if(id) {
                const idx = products.findIndex(p => p.id == id);
                if(idx !== -1) products[idx] = { id: parseInt(id), name, price, cat };
            } else {
                products.push({ id: Date.now(), name, price, cat });
            }
            localStorage.setItem('products', JSON.stringify(products));
            closeModal(); renderInventory(); renderPOS();
        }
        function deleteProd(id) {
            if(confirm("Delete item?")) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('products', JSON.stringify(products));
                renderInventory(); renderPOS();
            }
        }

        // --- ANALYTICS ---
        let salesChart, comboChart, peakChart;
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const daily = sales.filter(s => s.date.startsWith(today)).reduce((a,b) => a + b.total, 0);
            const itemCounts = {};
            sales.forEach(s => s.items.forEach(i => itemCounts[i.name] = (itemCounts[i.name] || 0) + i.qty));
            const sortedItems = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]);
            const top = sortedItems.length ? `${sortedItems[0][0]} (${sortedItems[0][1]})` : "--";
            
            const allNames = products.map(p => p.name);
            const soldNames = Object.keys(itemCounts);
            const unsold = allNames.filter(n => !soldNames.includes(n));
            let low = "--";
            if(unsold.length) low = unsold[0] + " (0)";
            else if(sortedItems.length) { const l = sortedItems[sortedItems.length-1]; low = `${l[0]} (${l[1]})`; }

            document.getElementById('statDaily').innerText = '₱' + daily.toFixed(2);
            document.getElementById('statCount').innerText = sales.length;
            document.getElementById('statTop').innerText = top;
            document.getElementById('statLow').innerText = low;

            // Chart Logic (Simplified for brevity)
            const ctxS = document.getElementById('salesChart').getContext('2d');
            if(salesChart) salesChart.destroy();
            const labels=[], data=[];
            for(let i=6; i>=0; i--) {
                const d=new Date(); d.setDate(d.getDate()-i); const ds=d.toISOString().split('T')[0];
                labels.push(ds.slice(5)); data.push(sales.filter(s=>s.date.startsWith(ds)).reduce((a,b)=>a+b.total,0));
            }
            salesChart=new Chart(ctxS,{type:'bar',data:{labels,datasets:[{label:'Sales',data,backgroundColor:'#3b82f6',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false}});

            // Combo Chart
            const pairs={};
            sales.forEach(s=>{ if(s.items.length>1){ const n=s.items.map(i=>i.name).sort(); for(let i=0;i<n.length;i++)for(let j=i+1;j<n.length;j++) pairs[n[i]+"+"+n[j]]=(pairs[n[i]+"+"+n[j]]||0)+1; }});
            const sPairs=Object.entries(pairs).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctxC = document.getElementById('comboChart').getContext('2d');
            if(comboChart) comboChart.destroy();
            if(sPairs.length) comboChart=new Chart(ctxC,{type:'doughnut',data:{labels:sPairs.map(p=>p[0]),datasets:[{data:sPairs.map(p=>p[1]),backgroundColor:['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:10,font:{size:9}}}}}});

            // Peak Chart
            const hC=new Array(24).fill(0); sales.forEach(s=>hC[new Date(s.date).getHours()]++);
            const hL=hC.map((_,i)=>i%6===0?(i>12?i-12+'pm':i+'am'):'');
            const ctxP = document.getElementById('peakChart').getContext('2d');
            if(peakChart) peakChart.destroy();
            peakChart=new Chart(ctxP,{type:'line',data:{labels:hL,datasets:[{label:'Orders',data:hC,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}}}}});
        }

        // --- AI ---
        function enterApiKey() { const k=prompt("Groq API Key:"); if(k){ localStorage.setItem('groq_key',k); apiKey=k; alert("Saved"); } }
        async function sendToAI() {
            if(!apiKey) return enterApiKey();
            const txt=document.getElementById('aiInput').value; if(!txt)return;
            const chat=document.getElementById('chatContainer');
            chat.innerHTML+=`<div class="flex gap-3 justify-end"><div class="bg-blue-600 text-white p-3 rounded-l-2xl rounded-br-2xl text-sm shadow">${txt}</div></div>`;
            document.getElementById('aiInput').value=''; chat.scrollTop=chat.scrollHeight;
            const ctxt=`Sales: ${document.getElementById('statDaily').innerText}. Top: ${document.getElementById('statTop').innerText}.`;
            try {
                const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
                    method:"POST",headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
                    body:JSON.stringify({messages:[{role:"system",content:`Sari-sari store advisor. Data: ${ctxt}. Brief answer.`},{role:"user",content:txt}],model:"llama3-8b-8192"})
                });
                const d=await res.json();
                chat.innerHTML+=`<div class="flex gap-3"><div class="bg-purple-600 w-8 h-8 rounded-full flex items-center justify-center text-white shrink-0 text-xs"><i class="fa-solid fa-robot"></i></div><div class="bg-white p-3 rounded-r-2xl rounded-bl-2xl text-sm shadow border">${d.choices[0].message.content}</div></div>`;
            } catch(e){ alert(e.message); }
            chat.scrollTop=chat.scrollHeight;
        }
    </script>
</body>
</html>
